#!/bin/bash
# ══════════════════════════════════════════════
# 전체 빌드 파이프라인
# "괜찮아, 엄마도 아프니까"
# 저자: 피지오 아카데미
# ══════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

echo ""
echo "══════════════════════════════════════════"
echo "  📚 전자책 빌드 시작"
echo "  「괜찮아, 엄마도 아프니까」"
echo "  저자: 피지오 아카데미"
echo "══════════════════════════════════════════"
echo ""

START_TIME=$(date +%s)

# ──────────────────────────────────────────────
# Step 1: 이미지 생성
# ──────────────────────────────────────────────
echo "──────────────────────────────────────────"
echo "  🎨 Step 1/3: 이미지 생성"
echo "──────────────────────────────────────────"
echo ""

node scripts/generate-images.js

echo ""

# ──────────────────────────────────────────────
# Step 2: 콘텐츠 병합
# ──────────────────────────────────────────────
echo "──────────────────────────────────────────"
echo "  📝 Step 2/3: 콘텐츠 병합"
echo "──────────────────────────────────────────"
echo ""

node scripts/merge-content.js

echo ""

# ──────────────────────────────────────────────
# Step 3: PDF 빌드
# ──────────────────────────────────────────────
echo "──────────────────────────────────────────"
echo "  📄 Step 3/3: PDF 빌드"
echo "──────────────────────────────────────────"
echo ""

bash scripts/build-pdf.sh

# ──────────────────────────────────────────────
# 완료
# ──────────────────────────────────────────────
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
MINUTES=$((ELAPSED / 60))
SECONDS=$((ELAPSED % 60))

echo ""
echo "══════════════════════════════════════════"
echo "  ✅ 전체 빌드 완료!"
echo "══════════════════════════════════════════"
echo "  📄 최종 파일: output/final.pdf"
echo "  ⏱️  소요 시간: ${MINUTES}분 ${SECONDS}초"
echo ""
echo "  빌드 산출물:"
echo "    output/complete-ebook.md  (병합 마크다운)"
echo "    output/ebook.html         (중간 HTML)"
echo "    output/final.pdf          (최종 PDF)"
echo ""
