<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Î∞îÏù¥Î∏å ÎùºÏù¥Îçî üö¥</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;touch-action:none}
canvas{display:block}
#retry{
  position:absolute;padding:16px 44px;font-size:20px;font-weight:bold;
  border:none;border-radius:10px;cursor:pointer;display:none;
  background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;
  box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:10;
  font-family:'Segoe UI',sans-serif;letter-spacing:1px;
  left:50%;transform:translateX(-50%);
}
#retry:hover{background:linear-gradient(135deg,#ee5a24,#ff6b6b)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<button id="retry">üîÑ Îã§Ïãú ÏãúÏûë</button>
<script>
'use strict';
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d'),retryBtn=document.getElementById('retry');
let W,H;

function resize(){
  W=window.innerWidth; H=window.innerHeight;
  canvas.width=W; canvas.height=H;
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
}
window.addEventListener('resize',resize); resize();

// ‚ïê‚ïê‚ïê Audio ‚ïê‚ïê‚ïê
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
}
// Helper: quick oscillator note
function playNote(freq,dur,type,vol,delay){
  const t=audioCtx.currentTime+(delay||0);
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type||'sine'; o.frequency.setValueAtTime(freq,t);
  g.gain.setValueAtTime(vol||0.15,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+dur);
  return o;
}
// Helper: noise burst
function playNoise(dur,freq,vol,delay){
  const t=audioCtx.currentTime+(delay||0);
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*dur,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);
  const src=audioCtx.createBufferSource(); src.buffer=buf;
  const f=audioCtx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=freq||1000; f.Q.value=1;
  const g=audioCtx.createGain(); g.gain.setValueAtTime(vol||0.15,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  src.connect(f); f.connect(g); g.connect(audioCtx.destination); src.start(t);
}

function playEventSound(type){
  ensureAudio();
  const t=audioCtx.currentTime;
  switch(type){
    case 'balloon': { // ÌíçÏÑ†: Ìå°Ìå° ÌÑ∞ÏßÄÎäî ÏÜåÎ¶¨ (ÏßßÏùÄ ÎÖ∏Ïù¥Ï¶à Ïó∞ÌÉÄ)
      for(let i=0;i<4;i++) playNoise(0.08,3000,0.2,i*0.07);
      playNote(1200,0.15,'sine',0.1,0.3);
      break;
    }
    case 'giant': { // Í±∞Ïù∏: ÏõÖÏû•Ìïú Ï†ÄÏùå ÌååÏõåÏóÖ
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.setValueAtTime(80,t); o.frequency.exponentialRampToValueAtTime(300,t+0.5);
      g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0.25,t+0.2); g.gain.exponentialRampToValueAtTime(0.001,t+0.8);
      o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.8);
      playNote(150,0.6,'square',0.08);
      playNote(600,0.3,'sine',0.1,0.3);
      break;
    }
    case 'fart': { // Î∞©Íµ¨: Î∂ÄÏö∞ÏõÖ~ Ï†ÄÏùå ÏßÑÎèô
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.setValueAtTime(60,t); o.frequency.linearRampToValueAtTime(90,t+0.15);
      o.frequency.linearRampToValueAtTime(50,t+0.4);
      g.gain.setValueAtTime(0.25,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.5);
      o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.5);
      playNoise(0.3,200,0.1,0.05);
      break;
    }
    case 'hail': { // Ïö∞Î∞ï: ÌååÎùºÎùºÎùº ÎÜíÏùÄ ÌÉÄÍ≤©Ïùå
      for(let i=0;i<8;i++){
        playNoise(0.04,4000+Math.random()*3000,0.12,i*0.05);
        playNote(2000+Math.random()*2000,0.03,'sine',0.06,i*0.05);
      }
      break;
    }
    case 'cheerleader': { // ÏπòÏñ¥Î¶¨Îçî: Îπ†Îπ†Îπ†~ Ìå°ÌååÎ•¥
      [523,659,784,1047].forEach((f,i)=>{
        playNote(f,0.2,'square',0.1,i*0.12);
        playNote(f*1.5,0.15,'sine',0.06,i*0.12+0.05);
      });
      playNoise(0.15,5000,0.08,0.55);
      break;
    }
    case 'rainbow': { // Î¨¥ÏßÄÍ∞ú: Í∏ÄÎ¶¨ÏÇ∞ÎèÑ ÏÉÅÏäπÏùå
      for(let i=0;i<12;i++){
        playNote(400+i*100,0.3-i*0.015,'sine',0.08,i*0.04);
      }
      playNote(1600,0.5,'triangle',0.1,0.5);
      break;
    }
    case 'firework': { // Î∂àÍΩÉÎÜÄÏù¥: ÏäàÏäâ ‚Üí Ìçô!
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(300,t); o.frequency.exponentialRampToValueAtTime(2500,t+0.3);
      g.gain.setValueAtTime(0.15,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
      o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.35);
      playNoise(0.25,5000,0.3,0.3);
      playNote(1500,0.15,'sine',0.1,0.32);
      playNote(2000,0.1,'sine',0.08,0.38);
      break;
    }
    case 'butterfly': { // ÎÇòÎπÑ: Í∞ÄÎ≥çÍ≤å ÎÇ†Í∞ØÏßì ÌîåÎü¨ÌÑ∞
      for(let i=0;i<6;i++){
        playNote(1800+Math.sin(i)*400,0.08,'sine',0.06,i*0.09);
        playNote(2200-Math.sin(i)*300,0.06,'triangle',0.04,i*0.09+0.04);
      }
      break;
    }
    case 'star': { // Ïä§ÌÉÄ: Î∞òÏßùÎ∞òÏßù Ï∞®ÏûÑÎ≤®
      [1047,1319,1568,2093,1568,2093].forEach((f,i)=>{
        playNote(f,0.25,'sine',0.12,i*0.1);
      });
      playNote(2093,0.6,'triangle',0.08,0.6);
      break;
    }
    case 'heart': { // ÌïòÌä∏: ÎëêÍ∑ºÎëêÍ∑º Ïã¨Ïû•Î∞ïÎèô + Î∞òÏßù
      for(let i=0;i<4;i++){
        playNote(200,0.08,'sine',0.2,i*0.25);
        playNote(250,0.06,'sine',0.15,i*0.25+0.1);
      }
      playNote(880,0.3,'sine',0.08,0.4);
      break;
    }
    case 'confetti': { // Ï∂ïÌïò: Îπµ! Ìè≠Ï£Ω + ÏäàÎ•¥Î•¥
      playNoise(0.15,6000,0.3);
      playNoise(0.4,3000,0.1,0.1);
      playNote(800,0.12,'square',0.1,0.05);
      playNote(1200,0.1,'square',0.08,0.1);
      for(let i=0;i<5;i++) playNote(2000+Math.random()*2000,0.08,'sine',0.04,0.15+i*0.06);
      break;
    }
    case 'speed': { // Ïä§ÌîºÎìú: Î∂ÄÏïô~ Í∞ÄÏÜç ÏóîÏßÑÏùå
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(800,t+0.4);
      g.gain.setValueAtTime(0.18,t); g.gain.linearRampToValueAtTime(0.22,t+0.2); g.gain.exponentialRampToValueAtTime(0.001,t+0.6);
      o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.6);
      playNoise(0.3,1500,0.08,0.1);
      break;
    }
    case 'disco': { // ÎîîÏä§ÏΩî: Îë†Ï∏†Îë†Ï∏† ÎπÑÌä∏
      for(let i=0;i<4;i++){
        playNote(80,0.1,'square',0.2,i*0.2);          // kick
        playNoise(0.04,8000,0.12,i*0.2+0.1);          // hi-hat
        if(i%2) playNoise(0.06,3000,0.15,i*0.2+0.1);  // snare
      }
      playNote(400,0.15,'square',0.08,0.05);
      break;
    }
    case 'angel': { // Ï≤úÏÇ¨: Ïã†ÏÑ±Ìïú ÌôîÏùå ÏΩîÎü¨Ïä§
      [523,659,784].forEach(f=>{
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type='sine'; o.frequency.setValueAtTime(f,t);
        g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.1,t+0.3);
        g.gain.linearRampToValueAtTime(0.08,t+0.7); g.gain.exponentialRampToValueAtTime(0.001,t+1.2);
        o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+1.2);
      });
      playNote(1568,0.6,'sine',0.05,0.4);
      break;
    }
    case 'sakura': { // Î≤öÍΩÉ: ÏùºÎ≥∏Ìíç ÌéúÌÉÄÌÜ†Îãâ Î©úÎ°úÎîî
      [523,587,698,784,1047,784].forEach((f,i)=>{
        playNote(f,0.2,'triangle',0.1,i*0.1);
      });
      playNote(523,0.4,'sine',0.06,0.6);
      break;
    }
    default: { // fallback
      playNote(880,0.15,'sine',0.15);
      playNote(1320,0.12,'sine',0.1,0.08);
    }
  }
}
function playCrashSound(){
  ensureAudio(); const t=audioCtx.currentTime;
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.3,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2);
  const src=audioCtx.createBufferSource(); src.buffer=buf;
  const f=audioCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=300;
  const g=audioCtx.createGain(); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
  src.connect(f); f.connect(g); g.connect(audioCtx.destination); src.start(t);
}

// ‚ïê‚ïê‚ïê Road Constants ‚ïê‚ïê‚ïê
const SEGMENT_LENGTH = 200;
const RUMBLE_LENGTH = 3;
const DRAW_DISTANCE = 150;
const LANES = 3;
const ROAD_W = 2000;
const FIELD_OF_VIEW = 100;
const CAMERA_HEIGHT = 1800;
const CAMERA_DEPTH = 1/Math.tan((FIELD_OF_VIEW/2)*Math.PI/180);
const PLAYER_Z_OFFSET = CAMERA_DEPTH*CAMERA_HEIGHT/0.64; // world Z where player sits on screen (H*0.82)

const COLORS = {
  SKY: '#72D7EE',
  TREE: '#005108',
  FOG: '#005108',
  LIGHT: { road:'#6B6B6B', grass:'#10AA10', rumble:'#555555', lane:'#CCCCCC' },
  DARK:  { road:'#696969', grass:'#009A00', rumble:'#BBBBBB', lane:'#696969' },
  START: { road:'#fff', grass:'#fff', rumble:'#fff' },
  FINISH:{ road:'#000', grass:'#000', rumble:'#000' }
};

// ‚ïê‚ïê‚ïê Road Building ‚ïê‚ïê‚ïê
const segments=[];
let movingObstacles=[];
const totalSegments = 6000;

function addSegments(enter,hold,leave,curve,y){
  const startIdx=segments.length;
  const n=enter+hold+leave;
  for(let i=0;i<n;i++){
    const seg={
      index: segments.length,
      p: {world:{x:0,y:0,z:0},screen:{x:0,y:0,w:0},scale:0},
      curve: 0,
      y: 0,
      sprites:[],
      clip: 0
    };
    if(i<enter) seg.curve=curve*easeIn(i/enter);
    else if(i<enter+hold) seg.curve=curve;
    else seg.curve=curve*easeOut((i-enter-hold)/leave);

    if(i<enter) seg.y=y*easeIn(i/enter);
    else if(i<enter+hold) seg.y=y;
    else seg.y=y*easeOut((i-enter-hold)/leave);

    seg.p.world.z=segments.length*SEGMENT_LENGTH;
    segments.push(seg);
  }
}
function easeIn(t){return t*t}
function easeOut(t){return 1-(1-t)*(1-t)}
function easeInOut(t){return t<0.5?2*t*t:1-2*(1-t)*(1-t)}

function addStraight(n){addSegments(25,n-50,25,0,0)}
function addCurve(n,curve,hills){addSegments(25,n-50,25,curve,hills||0)}
function addHill(n,height){addSegments(25,n-50,25,0,height)}
function addSCurves(){
  addCurve(100,3,0); addCurve(100,-3,0);
  addCurve(100,4,0); addCurve(100,-4,0);
  addCurve(100,2,500); addCurve(100,-2,-500);
}

function buildRoad(){
  segments.length=0;
  addStraight(80);
  addCurve(100, 3, 0);
  addHill(80, 800);
  addCurve(100, -4, 0);
  addStraight(60);
  addCurve(120, 5, 500);
  addHill(80, -600);
  addCurve(100, -3, 0);
  addStraight(80);
  addSCurves();
  addStraight(60);
  addCurve(80, 6, 400);
  addHill(60, -800);
  addCurve(100, -5, 600);
  addStraight(100);
  addCurve(120, -4, -400);
  addSCurves();
  addStraight(200);

  // Place obstacles, items, sidewalk people
  for(let i=0;i<segments.length;i++){
    const seg=segments[i];
    // Vehicles on road ‚Äî added to movingObstacles array
    if(i>30 && i%25===0){
      const vTypes=['bus','taxi','car','moto'];
      const vt=vTypes[(Math.random()*vTypes.length)|0];
      const side=(Math.random()<0.5)?-1:1;
      const offset=side*(0.3+Math.random()*0.4);
      const oncoming=side<0;
      const baseSpeed=vt==='bus'?0.3:vt==='taxi'?0.5:vt==='car'?0.45:0.6;
      const spd=maxSpeed*(baseSpeed+Math.random()*0.25);
      movingObstacles.push({
        worldZ:i*SEGMENT_LENGTH,initZ:i*SEGMENT_LENGTH,
        offset:offset,vehicle:vt,oncoming:oncoming,
        speed:oncoming?-spd:spd,
        colorIdx:(Math.random()*8)|0
      });
    }
    // Animals on road (dog/cat)
    if(i>50 && i%80===0){
      const aType=Math.random()<0.5?'dog':'cat';
      const side=(Math.random()<0.5)?-1:1;
      const offset=side*(0.15+Math.random()*0.3);
      const oncoming=side<0;
      const spd=maxSpeed*(0.03+Math.random()*0.06);
      movingObstacles.push({
        worldZ:i*SEGMENT_LENGTH,initZ:i*SEGMENT_LENGTH,
        offset:offset,vehicle:aType,oncoming:oncoming,
        speed:oncoming?-spd:spd,
        colorIdx:0
      });
    }
    // Sidewalk people & street life
    if(i>20 && i%22===0){
      const types=['üö∂','üö∂‚Äç‚ôÄÔ∏è','üèÉ','üèÉ‚Äç‚ôÄÔ∏è','üë´','üßë‚Äçü¶Ø','üêï','üõ¥','‚òï','üì±','üßπ','üë¥'];
      const e=types[(i*3+Math.random()*3|0)%types.length];
      const side=(Math.random()<0.5)?-1.3:1.3;
      seg.sprites.push({type:'scenery',emoji:e,offset:side});
    }
    // Trees & roadside objects (alternate types by position)
    if(i>5 && i%8===0){
      const zone=(i/80|0)%4; // landscape zone changes every ~80 segments
      const trees=zone===0?['üå≥','üå≤','üå≥','üå≤']:zone===1?['üå¥','üå¥','üåµ','üåø']:zone===2?['üå≥','üå≤','üéÑ','üå≥']:['üåæ','üåª','üåø','üå≥'];
      const e=trees[(i/8|0)%trees.length];
      const side=(i%16===0)?-1.5:1.5;
      seg.sprites.push({type:'scenery',emoji:e,offset:side});
    }
    // Occasional buildings & landmarks (sparse, far from road)
    if(i>30 && i%50===0){
      const blds=['üè†','üè™','üè¢','‚õ™','üè´','‚õΩ'];
      const e=blds[(i/50|0)%blds.length];
      const side=(i%100===0)?-2.0:2.0;
      seg.sprites.push({type:'scenery',emoji:e,offset:side});
    }
    // Gift items
    if(i>40 && i%80===0){
      const lane=(Math.random()-0.5)*0.7;
      seg.sprites.push({type:'item',emoji:'üéÅ',offset:lane,collected:false});
    }
  }
}

// ‚ïê‚ïê‚ïê Game State ‚ïê‚ïê‚ïê
const maxSpeed=SEGMENT_LENGTH*18;
let position=0, speed=0, playerX=0, tilt=0, distance=0;
let gameOver=false, flashAlpha=0, crashTimer=0, crashDone=false, crashDir=1;
let floatingTexts=[];
let particles=[];       // generic particle system
let activeEvent=null;   // current special event {type, timer, duration, ...}
let invincible=false;
let playerScale=1;

buildRoad();

// ‚ïê‚ïê‚ïê Update Moving Obstacles ‚ïê‚ïê‚ïê
function updateObstacles(dt){
  const trackLen=segments.length*SEGMENT_LENGTH;
  for(const ob of movingObstacles){
    ob.worldZ=increase(ob.worldZ,ob.speed*dt,trackLen);
  }
}
const accel=maxSpeed/6;
const braking=maxSpeed/3;
const decel=maxSpeed/10;
const offRoadDecel=maxSpeed/4;
const offRoadLimit=maxSpeed/5;
const centrifugal=0.15;
const steerSensitivity=0.8;

// ‚ïê‚ïê‚ïê Item Event System ‚ïê‚ïê‚ïê
const ITEM_EVENTS=[
  {type:'balloon',     msg:'üéà ÌíçÏÑ† ÌååÌã∞!',      duration:4},
  {type:'giant',       msg:'üí™ Í±∞Ïù∏ Î™®Îìú!',       duration:10},
  {type:'fart',        msg:'üí® Î∞©Íµ¨ Î∂ÄÏä§ÌÑ∞!',      duration:6},
  {type:'hail',        msg:'üßä Ïö∞Î∞ï Ìè≠Ìíç!',       duration:5},
  {type:'cheerleader', msg:'üì£ ÏπòÏñ¥Î¶¨Îçî ÏùëÏõê!',    duration:8},
  {type:'rainbow',     msg:'üåà Î¨¥ÏßÄÍ∞ú Î°úÎìú!',      duration:8},
  {type:'firework',    msg:'üéÜ Î∂àÍΩÉÎÜÄÏù¥!',        duration:6},
  {type:'butterfly',   msg:'ü¶ã ÎÇòÎπÑ Îñº!',         duration:7},
  {type:'star',        msg:'‚≠ê Ïä§ÌÉÄ ÌååÏõå!',        duration:8},
  {type:'heart',       msg:'üíï ÌïòÌä∏ ÏÉ§Ïõå!',        duration:6},
  {type:'confetti',    msg:'üéä Ï∂ïÌïò Ìè≠Ï£Ω!',       duration:6},
  {type:'speed',       msg:'‚ö° Ïä§ÌîºÎìú Î∂ÄÏä§Ìä∏!',    duration:6},
  {type:'disco',       msg:'ü™© ÎîîÏä§ÏΩî ÌÉÄÏûÑ!',      duration:8},
  {type:'angel',       msg:'üòá Ï≤úÏÇ¨Ïùò ÎÇ†Í∞ú!',      duration:8},
  {type:'sakura',      msg:'üå∏ Î≤öÍΩÉ ÎπÑ!',         duration:3.5},
];

// ‚ïê‚ïê‚ïê Input ‚ïê‚ïê‚ïê
const keys={};
document.addEventListener('keydown',e=>{keys[e.key]=true;ensureAudio();e.preventDefault()});
document.addEventListener('keyup',e=>{keys[e.key]=false});

let touchActive=false,touchSX=0,touchSY=0,touchDX=0,touchDY=0;
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();ensureAudio();
  const t=e.touches[0];touchSX=t.clientX;touchSY=t.clientY;touchDX=0;touchDY=0;touchActive=true;
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();const t=e.touches[0];touchDX=t.clientX-touchSX;touchDY=t.clientY-touchSY;
},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();touchActive=false;touchDX=0;touchDY=0},{passive:false});

// ‚ïê‚ïê‚ïê Helpers ‚ïê‚ïê‚ïê
function findSegment(z){return segments[Math.floor(z/SEGMENT_LENGTH)%segments.length]}
function percentRemaining(n,total){return(n%total)/total}
function interpolate(a,b,p){return a+(b-a)*p}
function increase(start,increment,max){let r=start+increment;while(r>=max)r-=max;while(r<0)r+=max;return r}
function project3d(p,cameraX,cameraY,cameraZ,cameraDepth,width,height,roadWidth){
  p.camera={x:p.world.x-cameraX,y:p.world.y-cameraY,z:p.world.z-cameraZ};
  if(p.camera.z<=0) {p.screen={x:0,y:0,w:0};p.scale=0;return;}
  p.scale=cameraDepth/p.camera.z;
  p.screen={
    x: Math.round(width/2+p.scale*p.camera.x*width/2),
    y: Math.round(height/2-p.scale*p.camera.y*height/2),
    w: Math.round(p.scale*roadWidth*width/2)
  };
}
function drawPoly(ctx,x1,y1,x2,y2,x3,y3,x4,y4,color){
  ctx.fillStyle=color;ctx.beginPath();
  ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.lineTo(x3,y3);ctx.lineTo(x4,y4);
  ctx.closePath();ctx.fill();
}

// ‚ïê‚ïê‚ïê Draw Background ‚ïê‚ïê‚ïê
function drawBg(curve){
  // Sky gradient
  const skyG=ctx.createLinearGradient(0,0,0,H*0.5);
  skyG.addColorStop(0,'#1a0533');
  skyG.addColorStop(0.35,'#3b1f6e');
  skyG.addColorStop(0.65,'#6a4c93');
  skyG.addColorStop(1,'#f0a060');
  ctx.fillStyle=skyG;ctx.fillRect(0,0,W,H*0.5);

  // Sun
  const sunX=W*0.5-curve*0.7;
  const sunY=H*0.28;
  const sunG=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,70);
  sunG.addColorStop(0,'rgba(255,230,120,1)');
  sunG.addColorStop(0.4,'rgba(255,180,80,0.6)');
  sunG.addColorStop(1,'rgba(255,120,30,0)');
  ctx.fillStyle=sunG;ctx.beginPath();ctx.arc(sunX,sunY,70,0,Math.PI*2);ctx.fill();

  // Mountains far
  ctx.fillStyle='#2d1b4e';ctx.beginPath();ctx.moveTo(0,H*0.48);
  for(let x=0;x<=W;x+=30){
    const h=Math.sin((x-curve*0.4)*0.003)*45+Math.sin((x-curve*0.4)*0.007)*25+Math.sin((x-curve*0.3)*0.0012)*55;
    ctx.lineTo(x,H*0.42-h);
  }
  ctx.lineTo(W,H*0.5);ctx.lineTo(0,H*0.5);ctx.fill();

  // Mountains near
  ctx.fillStyle='#3d2960';ctx.beginPath();ctx.moveTo(0,H*0.49);
  for(let x=0;x<=W;x+=25){
    const h=Math.sin((x-curve*0.7+200)*0.005)*30+Math.sin((x-curve*0.6)*0.009)*20;
    ctx.lineTo(x,H*0.46-h);
  }
  ctx.lineTo(W,H*0.5);ctx.lineTo(0,H*0.5);ctx.fill();

  // City
  ctx.fillStyle='#1a1030';
  const bldgs=[40,75,55,95,60,42,88,68,48,82,62,100,38,72,92,52,78,58,102,42];
  let bx=(-curve*1.1)%55-55;
  for(let i=0;bx<W+60;i++){
    const bw=22+(i*7)%18; const bh=bldgs[i%bldgs.length];
    ctx.fillRect(bx,H*0.495-bh,bw,bh+5);
    // windows
    ctx.fillStyle='rgba(255,200,80,0.25)';
    for(let wy=H*0.495-bh+6;wy<H*0.495-3;wy+=10){
      for(let wx=bx+3;wx<bx+bw-3;wx+=6){
        if(((wx*7+wy*13+i*3)%10)>4) ctx.fillRect(wx,wy,2.5,4);
      }
    }
    ctx.fillStyle='#1a1030';
    bx+=bw+4+(i*3)%8;
  }
}

// ‚ïê‚ïê‚ïê Draw Segment ‚ïê‚ïê‚ïê
function drawSegment(width,lanes,x1,y1,w1,x2,y2,w2,color){
  const rumbleW1=w1/Math.max(6,2*lanes);
  const rumbleW2=w2/Math.max(6,2*lanes);
  const laneW1=w1*0.02;
  const laneW2=w2*0.02;

  // Grass
  ctx.fillStyle=color.grass;
  ctx.fillRect(0,y2,width,y1-y2);

  // Rumble
  drawPoly(ctx,x1-w1-rumbleW1,y1,x1-w1,y1,x2-w2,y2,x2-w2-rumbleW2,y2,color.rumble);
  drawPoly(ctx,x1+w1,y1,x1+w1+rumbleW1,y1,x2+w2+rumbleW2,y2,x2+w2,y2,color.rumble);

  // Road
  drawPoly(ctx,x1-w1,y1,x1+w1,y1,x2+w2,y2,x2-w2,y2,color.road);

  // Lanes
  if(color.lane){
    const lw1=w1*0.015,lw2=w2*0.015;
    for(let l=1;l<lanes;l++){
      const lx1=x1-w1+l*2*w1/lanes;
      const lx2=x2-w2+l*2*w2/lanes;
      drawPoly(ctx,lx1-lw1,y1,lx1+lw1,y1,lx2+lw2,y2,lx2-lw2,y2,color.lane);
    }
  }

  // Center line
  if(color.lane){
    const cw1=w1*0.02,cw2=w2*0.02;
    drawPoly(ctx,x1-cw1,y1,x1+cw1,y1,x2+cw2,y2,x2-cw2,y2,'#ffff66');
  }

  // Road edge white lines
  const ew1=w1*0.018,ew2=w2*0.018;
  drawPoly(ctx,x1-w1-ew1,y1,x1-w1+ew1,y1,x2-w2+ew2,y2,x2-w2-ew2,y2,'#ffffff');
  drawPoly(ctx,x1+w1-ew1,y1,x1+w1+ew1,y1,x2+w2+ew2,y2,x2+w2-ew2,y2,'#ffffff');
}

// ‚ïê‚ïê‚ïê Draw Player (back view cyclist) ‚ïê‚ïê‚ïê
function drawPlayer(){
  const px=W/2+(playerX*W/3.2);
  const py=H*0.82;
  const s=Math.min(W,H)*0.0012; // scale factor
  ctx.save();
  ctx.translate(px,py);
  if(playerScale!==1){
    ctx.scale(playerScale,playerScale);
  }

  // Crash: bounce away then fall to ground
  if(gameOver){
    const t=Math.min(crashTimer,1.2);
    // Phase 1 (0~0.4s): bounce up and sideways from impact
    // Phase 2 (0.4~1.2s): fall to ground
    if(t<0.4){
      const p=t/0.4;
      const bounceX=crashDir*p*60*s;
      const bounceY=-Math.sin(p*Math.PI)*50*s; // arc upward
      const spin=crashDir*p*0.8;
      ctx.translate(bounceX,bounceY);
      ctx.rotate(spin);
    } else {
      const p=Math.min((t-0.4)/0.8,1);
      const baseX=crashDir*60*s;
      const slideX=baseX+crashDir*p*20*s;
      const dropY=p*p*45*s; // gravity drop
      const spin=crashDir*(0.8+p*0.7);
      ctx.translate(slideX,dropY);
      ctx.rotate(spin);
    }
  } else {
    ctx.rotate(tilt*-0.18);
  }

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.35)';
  ctx.beginPath();ctx.ellipse(0,38*s,32*s,7*s,0,0,Math.PI*2);ctx.fill();

  // Pedal animation based on distance
  const pedal=gameOver?0:Math.sin(distance*0.8)*0.35;

  // ‚îÄ‚îÄ Back wheel ‚îÄ‚îÄ
  ctx.strokeStyle='#333';ctx.lineWidth=3*s;
  ctx.beginPath();ctx.ellipse(0,30*s,14*s,5*s,0,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle='#666';ctx.lineWidth=1.5*s;
  for(let a=0;a<Math.PI*2;a+=Math.PI/4){
    ctx.beginPath();ctx.moveTo(0,30*s);
    ctx.lineTo(Math.cos(a)*12*s,(30+Math.sin(a)*4)*s);ctx.stroke();
  }
  // Tire
  ctx.strokeStyle='#222';ctx.lineWidth=3.5*s;
  ctx.beginPath();ctx.ellipse(0,30*s,14*s,5*s,0,0,Math.PI*2);ctx.stroke();

  // ‚îÄ‚îÄ Frame ‚îÄ‚îÄ
  ctx.strokeStyle='#e03030';ctx.lineWidth=3*s;ctx.lineCap='round';
  // Seat tube
  ctx.beginPath();ctx.moveTo(0,28*s);ctx.lineTo(0,-10*s);ctx.stroke();
  // Top tube / handlebar post
  ctx.beginPath();ctx.moveTo(0,-10*s);ctx.lineTo(0,-30*s);ctx.stroke();
  // Seat stays (V shape down to wheel)
  ctx.lineWidth=2*s;
  ctx.beginPath();ctx.moveTo(0,0*s);ctx.lineTo(-8*s,28*s);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,0*s);ctx.lineTo(8*s,28*s);ctx.stroke();

  // ‚îÄ‚îÄ Seat ‚îÄ‚îÄ
  ctx.fillStyle='#333';
  ctx.beginPath();ctx.ellipse(0,-12*s,7*s,3*s,0,0,Math.PI*2);ctx.fill();

  // ‚îÄ‚îÄ Handlebars (seen from back = wide bar) ‚îÄ‚îÄ
  ctx.strokeStyle='#888';ctx.lineWidth=2.5*s;
  ctx.beginPath();ctx.moveTo(-18*s,-32*s);ctx.lineTo(18*s,-32*s);ctx.stroke();
  // Grips
  ctx.strokeStyle='#333';ctx.lineWidth=4*s;
  ctx.beginPath();ctx.moveTo(-18*s,-32*s);ctx.lineTo(-22*s,-32*s);ctx.stroke();
  ctx.beginPath();ctx.moveTo(18*s,-32*s);ctx.lineTo(22*s,-32*s);ctx.stroke();

  // ‚îÄ‚îÄ Legs (pedaling animation) ‚îÄ‚îÄ
  const lKneeX=-6*s, rKneeX=6*s;
  const lFootY=(18+pedal*12)*s, rFootY=(18-pedal*12)*s;
  // Left leg
  ctx.strokeStyle='#d4a574';ctx.lineWidth=5*s;
  ctx.beginPath();ctx.moveTo(-5*s,-2*s);ctx.quadraticCurveTo(lKneeX,(8)*s,-8*s,lFootY);ctx.stroke();
  // Right leg
  ctx.beginPath();ctx.moveTo(5*s,-2*s);ctx.quadraticCurveTo(rKneeX,(8)*s,8*s,rFootY);ctx.stroke();
  // Shoes
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.ellipse(-8*s,lFootY,4*s,2.5*s,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(8*s,rFootY,4*s,2.5*s,0,0,Math.PI*2);ctx.fill();

  // ‚îÄ‚îÄ Torso (back view = wider) ‚îÄ‚îÄ
  ctx.fillStyle='#2196F3'; // blue jersey
  ctx.beginPath();
  ctx.moveTo(-12*s,-8*s);ctx.lineTo(12*s,-8*s);
  ctx.lineTo(10*s,-28*s);ctx.lineTo(-10*s,-28*s);
  ctx.closePath();ctx.fill();
  // Jersey stripe
  ctx.fillStyle='#1565C0';
  ctx.fillRect(-2*s,-26*s,4*s,16*s);

  // ‚îÄ‚îÄ Arms (reaching to handlebars) ‚îÄ‚îÄ
  ctx.strokeStyle='#d4a574';ctx.lineWidth=4*s;
  ctx.beginPath();ctx.moveTo(-11*s,-26*s);ctx.quadraticCurveTo(-16*s,-30*s,-20*s,-32*s);ctx.stroke();
  ctx.beginPath();ctx.moveTo(11*s,-26*s);ctx.quadraticCurveTo(16*s,-30*s,20*s,-32*s);ctx.stroke();

  // ‚îÄ‚îÄ Head (back of helmet) ‚îÄ‚îÄ
  // Helmet
  ctx.fillStyle='#ff5722';
  ctx.beginPath();ctx.ellipse(0,-38*s,10*s,9*s,0,0,Math.PI*2);ctx.fill();
  // Helmet shine
  ctx.fillStyle='rgba(255,255,255,0.25)';
  ctx.beginPath();ctx.ellipse(-3*s,-41*s,5*s,4*s,0,0,Math.PI*2);ctx.fill();
  // Helmet vents
  ctx.strokeStyle='#d84315';ctx.lineWidth=1.5*s;
  ctx.beginPath();ctx.moveTo(-4*s,-44*s);ctx.lineTo(-4*s,-36*s);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,-45*s);ctx.lineTo(0,-36*s);ctx.stroke();
  ctx.beginPath();ctx.moveTo(4*s,-44*s);ctx.lineTo(4*s,-36*s);ctx.stroke();
  // Neck
  ctx.fillStyle='#d4a574';
  ctx.fillRect(-4*s,-30*s,8*s,4*s);

  ctx.restore();
}

// ‚ïê‚ïê‚ïê Draw Sprite (non-vehicle) ‚ïê‚ïê‚ïê
function drawSprite(emoji,screenX,screenY,roadW){
  const sz=Math.max(4,roadW*0.12);
  if(sz<3||screenY<0) return;
  ctx.save();
  ctx.font=Math.round(sz)+'px serif';
  ctx.textAlign='center';
  ctx.textBaseline='bottom';
  ctx.fillText(emoji,screenX,screenY);
  ctx.restore();
}

// ‚ïê‚ïê‚ïê Draw Animal obstacle ‚ïê‚ïê‚ïê
function drawAnimal(type,s,oncoming){
  if(type==='dog'){
    // Body
    ctx.fillStyle='#8B5E3C';
    ctx.beginPath();ctx.ellipse(0,-5*s,6*s,4*s,0,0,Math.PI*2);ctx.fill();
    // Head
    ctx.fillStyle='#A0714F';
    ctx.beginPath();ctx.arc(oncoming?-5*s:5*s,-7*s,3*s,0,Math.PI*2);ctx.fill();
    // Ears
    ctx.fillStyle='#6B3F1F';
    const hx=oncoming?-5*s:5*s;
    ctx.beginPath();ctx.ellipse(hx-2*s,-10*s,1.2*s,2*s,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(hx+2*s,-10*s,1.2*s,2*s,0,0,Math.PI*2);ctx.fill();
    // Legs
    ctx.fillStyle='#8B5E3C';
    for(const lx of [-4,-1.5,1.5,4]){
      ctx.fillRect(lx*s,-1*s,1.5*s,2*s);
    }
    // Tail
    if(!oncoming){
      ctx.strokeStyle='#6B3F1F';ctx.lineWidth=1.2*s;
      ctx.beginPath();ctx.arc(-7*s,-7*s,3*s,0.3,-1.2);ctx.stroke();
    }
  } else {
    // Cat
    ctx.fillStyle='#F5A623';
    ctx.beginPath();ctx.ellipse(0,-4*s,5*s,3*s,0,0,Math.PI*2);ctx.fill();
    // Head
    ctx.fillStyle='#F5A623';
    const hx=oncoming?-4*s:4*s;
    ctx.beginPath();ctx.arc(hx,-6*s,2.5*s,0,Math.PI*2);ctx.fill();
    // Ears (triangles)
    ctx.fillStyle='#E8961C';
    ctx.beginPath();ctx.moveTo(hx-2*s,-8*s);ctx.lineTo(hx-1*s,-11*s);ctx.lineTo(hx,- 8*s);ctx.fill();
    ctx.beginPath();ctx.moveTo(hx,- 8*s);ctx.lineTo(hx+1*s,-11*s);ctx.lineTo(hx+2*s,-8*s);ctx.fill();
    // Eyes
    ctx.fillStyle='#333';
    ctx.beginPath();ctx.arc(hx-1*s,-6*s,0.6*s,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(hx+1*s,-6*s,0.6*s,0,Math.PI*2);ctx.fill();
    // Legs
    ctx.fillStyle='#F5A623';
    for(const lx of [-3,-1,1,3]){
      ctx.fillRect(lx*s,-1*s,1.2*s,2*s);
    }
    // Tail
    if(!oncoming){
      ctx.strokeStyle='#E8961C';ctx.lineWidth=1.2*s;
      ctx.beginPath();ctx.arc(-6*s,-5*s,3*s,0.5,-1.0);ctx.stroke();
    }
  }
}

// ‚ïê‚ïê‚ïê Draw Vehicle (back/front view) ‚ïê‚ïê‚ïê
function drawVehicle(vType,screenX,screenY,roadW,oncoming,colorIdx){
  const s=Math.max(2,roadW*0.016); // scale unit ‚Äî 1 lane ‚âà 2*roadW/3
  if(s<1||screenY<0) return;
  ctx.save();
  ctx.translate(screenX,screenY);

  if(vType==='dog'){
    drawAnimal('dog',s*0.3,oncoming);
    ctx.restore();return;
  }
  if(vType==='cat'){
    drawAnimal('cat',s*0.22,oncoming);
    ctx.restore();return;
  }

  if(vType==='bus'){
    // ‚îÄ‚îÄ Î≤ÑÏä§: ÌÅ¨Í≥† ÎÜíÏùÄ Î∞ïÏä§Ìòï, Ï∞®ÏÑ† 90% ‚îÄ‚îÄ
    const bw=34*s, bh=40*s;
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.18)';
    ctx.beginPath();ctx.ellipse(0,1*s,bw/2+2*s,3*s,0,0,Math.PI*2);ctx.fill();
    // Main body
    const bodyColor=oncoming?'#1565C0':'#2E7D32';
    ctx.fillStyle=bodyColor;
    ctx.beginPath();ctx.roundRect(-bw/2,-bh,bw,bh,4*s);ctx.fill();
    // Darker lower panel
    ctx.fillStyle=oncoming?'#0D47A1':'#1B5E20';
    ctx.fillRect(-bw/2,-bh*0.3,bw,bh*0.3);
    // Roof bar
    ctx.fillStyle=oncoming?'#0D47A1':'#1B5E20';
    ctx.fillRect(-bw/2,-bh,bw,5*s);
    // Destination sign (top)
    ctx.fillStyle='#111';
    ctx.beginPath();ctx.roundRect(-bw/3,-bh-4*s,bw*2/3,4*s,2*s);ctx.fill();
    ctx.fillStyle='#ff9800';ctx.font=`bold ${Math.round(2.5*s)}px sans-serif`;ctx.textAlign='center';
    ctx.fillText('BUS',0,-bh-1.2*s);
    if(oncoming){
      // Big windshield
      ctx.fillStyle='rgba(160,220,255,0.9)';
      ctx.beginPath();ctx.roundRect(-bw/2+4*s,-bh+7*s,bw-8*s,18*s,3*s);ctx.fill();
      // Windshield glare
      ctx.fillStyle='rgba(255,255,255,0.15)';
      ctx.beginPath();ctx.roundRect(-bw/2+6*s,-bh+8*s,bw*0.3,16*s,2*s);ctx.fill();
      // Headlights (large, rectangular)
      ctx.fillStyle='#FFE082';
      ctx.beginPath();ctx.roundRect(-bw/2+3*s,-6*s,6*s,4*s,1.5*s);ctx.fill();
      ctx.beginPath();ctx.roundRect(bw/2-9*s,-6*s,6*s,4*s,1.5*s);ctx.fill();
      // Grille
      ctx.fillStyle='#888';
      ctx.fillRect(-bw/4,-3*s,bw/2,2.5*s);
      ctx.strokeStyle='#666';ctx.lineWidth=0.5*s;
      for(let gx=-bw/4+2*s;gx<bw/4;gx+=3*s){ctx.beginPath();ctx.moveTo(gx,-3*s);ctx.lineTo(gx,-0.5*s);ctx.stroke();}
    } else {
      // Rear window (smaller)
      ctx.fillStyle='rgba(160,220,255,0.75)';
      ctx.beginPath();ctx.roundRect(-bw/2+5*s,-bh+7*s,bw-10*s,12*s,3*s);ctx.fill();
      // Tail lights (wide, red)
      ctx.fillStyle='#d32f2f';
      ctx.beginPath();ctx.roundRect(-bw/2+2*s,-5*s,7*s,3.5*s,1*s);ctx.fill();
      ctx.beginPath();ctx.roundRect(bw/2-9*s,-5*s,7*s,3.5*s,1*s);ctx.fill();
      // Bumper
      ctx.fillStyle='#777';
      ctx.fillRect(-bw/2+3*s,-1.5*s,bw-6*s,2*s);
    }
    // Side stripe
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.fillRect(-bw/2,-bh*0.45,bw,2*s);
    // Outline
    ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=0.8*s;
    ctx.strokeRect(-bw/2,-bh,bw,bh);

  } else if(vType==='taxi'){
    // ‚îÄ‚îÄ ÌÉùÏãú: ÏÑ∏Îã®Ìòï, ÎÖ∏ÎûÄÏÉâ, ÏßÄÎ∂ï ÌëúÏãúÎì± (Ï∞®ÏÑ† 55%) ‚îÄ‚îÄ
    const cw=18*s, ch=20*s;
    const cabH=10*s; // cabin (upper) height
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.15)';
    ctx.beginPath();ctx.ellipse(0,1*s,cw/2+1*s,2.5*s,0,0,Math.PI*2);ctx.fill();
    // Lower body
    ctx.fillStyle='#FFC107';
    ctx.beginPath();ctx.roundRect(-cw/2,-ch+cabH,cw,ch-cabH,3*s);ctx.fill();
    // Cabin (narrower, rounded top)
    ctx.fillStyle='#FFD54F';
    ctx.beginPath();ctx.roundRect(-cw*0.4,-ch,cw*0.8,cabH,4*s);ctx.fill();
    // Taxi roof sign
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.roundRect(-4*s,-ch-4.5*s,8*s,4.5*s,2*s);ctx.fill();
    ctx.fillStyle='#d32f2f';ctx.font=`bold ${Math.round(2.8*s)}px sans-serif`;ctx.textAlign='center';
    ctx.fillText('TAXI',0,-ch-1.5*s);
    if(oncoming){
      // Windshield
      ctx.fillStyle='rgba(180,230,255,0.9)';
      ctx.beginPath();ctx.roundRect(-cw*0.35,-ch+1.5*s,cw*0.7,cabH-2.5*s,2*s);ctx.fill();
      // Glare
      ctx.fillStyle='rgba(255,255,255,0.18)';
      ctx.beginPath();ctx.roundRect(-cw*0.3,-ch+2*s,cw*0.25,cabH-4*s,1*s);ctx.fill();
      // Headlights (round)
      ctx.fillStyle='#FFE082';
      ctx.beginPath();ctx.arc(-cw/2+4*s,-4*s,2.5*s,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(cw/2-4*s,-4*s,2.5*s,0,Math.PI*2);ctx.fill();
      // Bumper
      ctx.fillStyle='#ccc';
      ctx.beginPath();ctx.roundRect(-cw/2+2*s,-1.5*s,cw-4*s,2*s,1*s);ctx.fill();
    } else {
      // Rear window
      ctx.fillStyle='rgba(180,230,255,0.8)';
      ctx.beginPath();ctx.roundRect(-cw*0.3,-ch+1.5*s,cw*0.6,cabH-3*s,2*s);ctx.fill();
      // Tail lights
      ctx.fillStyle='#d32f2f';
      ctx.beginPath();ctx.roundRect(-cw/2+2*s,-5*s,5*s,3*s,1*s);ctx.fill();
      ctx.beginPath();ctx.roundRect(cw/2-7*s,-5*s,5*s,3*s,1*s);ctx.fill();
      // Bumper
      ctx.fillStyle='#aaa';
      ctx.beginPath();ctx.roundRect(-cw/2+2*s,-1.5*s,cw-4*s,2*s,1*s);ctx.fill();
    }
    // Black stripe at bottom
    ctx.fillStyle='#333';
    ctx.fillRect(-cw/2,-1*s,cw,1.2*s);

  } else if(vType==='car'){
    // ‚îÄ‚îÄ ÏäπÏö©Ï∞®: ÏÑ∏Îã®Ìòï, Îã§ÏñëÌïú ÏÉâÏÉÅ (Ï∞®ÏÑ† 50%) ‚îÄ‚îÄ
    const cw=17*s, ch=18*s;
    const cabH=9*s;
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.15)';
    ctx.beginPath();ctx.ellipse(0,1*s,cw/2+1*s,2.5*s,0,0,Math.PI*2);ctx.fill();
    // Body color
    const colors=['#e53935','#1E88E5','#7CB342','#8E24AA','#FF7043','#26C6DA','#EC407A','#78909C'];
    const bodyCol=colors[(colorIdx||0)%colors.length];
    // Lower body
    ctx.fillStyle=bodyCol;
    ctx.beginPath();ctx.roundRect(-cw/2,-ch+cabH,cw,ch-cabH,3*s);ctx.fill();
    // Cabin (narrower)
    ctx.fillStyle=bodyCol;
    ctx.beginPath();ctx.roundRect(-cw*0.38,-ch,cw*0.76,cabH,5*s);ctx.fill();
    // Cabin darker shade
    ctx.fillStyle='rgba(0,0,0,0.1)';
    ctx.beginPath();ctx.roundRect(-cw*0.38,-ch,cw*0.76,cabH,5*s);ctx.fill();
    if(oncoming){
      // Windshield
      ctx.fillStyle='rgba(190,230,255,0.9)';
      ctx.beginPath();ctx.roundRect(-cw*0.33,-ch+1.5*s,cw*0.66,cabH-2.5*s,2*s);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.15)';
      ctx.beginPath();ctx.roundRect(-cw*0.28,-ch+2*s,cw*0.2,cabH-4*s,1*s);ctx.fill();
      // Headlights
      ctx.fillStyle='#FFE082';
      ctx.beginPath();ctx.arc(-cw/2+3.5*s,-4*s,2*s,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(cw/2-3.5*s,-4*s,2*s,0,Math.PI*2);ctx.fill();
      // Grille
      ctx.fillStyle='#555';
      ctx.beginPath();ctx.roundRect(-cw*0.2,-3.5*s,cw*0.4,2.5*s,1*s);ctx.fill();
    } else {
      // Rear window
      ctx.fillStyle='rgba(190,230,255,0.8)';
      ctx.beginPath();ctx.roundRect(-cw*0.28,-ch+1.5*s,cw*0.56,cabH-3*s,2*s);ctx.fill();
      // Tail lights
      ctx.fillStyle='#d32f2f';
      ctx.beginPath();ctx.roundRect(-cw/2+2*s,-5*s,4*s,2.5*s,1*s);ctx.fill();
      ctx.beginPath();ctx.roundRect(cw/2-6*s,-5*s,4*s,2.5*s,1*s);ctx.fill();
    }
    // Bottom trim
    ctx.fillStyle='#333';
    ctx.fillRect(-cw/2,-1*s,cw,1.2*s);

  } else if(vType==='moto'){
    // ‚îÄ‚îÄ Ïò§ÌÜ†Î∞îÏù¥: Ï¢ÅÍ≥† ÎùºÏù¥Îçî ÌÉëÏäπ (Ï∞®ÏÑ† 15%) ‚îÄ‚îÄ
    const mw=5*s, mh=10*s;
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.12)';
    ctx.beginPath();ctx.ellipse(0,1*s,5*s,2*s,0,0,Math.PI*2);ctx.fill();
    // Wheel base
    ctx.fillStyle='#222';
    ctx.beginPath();ctx.ellipse(0,-0.5*s,4.5*s,2*s,0,0,Math.PI*2);ctx.fill();
    // Body/engine
    ctx.fillStyle='#444';
    ctx.beginPath();ctx.roundRect(-mw/2,-mh,mw,mh,2*s);ctx.fill();
    // Rider torso
    ctx.fillStyle='#333';
    ctx.beginPath();ctx.ellipse(0,-mh-3*s,4.5*s,5*s,0,0,Math.PI*2);ctx.fill();
    // Jacket color
    ctx.fillStyle=oncoming?'#1565C0':'#c62828';
    ctx.beginPath();ctx.ellipse(0,-mh-2*s,4*s,4*s,0,0,Math.PI*2);ctx.fill();
    // Helmet
    ctx.fillStyle=oncoming?'#eee':'#222';
    ctx.beginPath();ctx.arc(0,-mh-7.5*s,3.5*s,0,Math.PI*2);ctx.fill();
    // Visor
    ctx.fillStyle='rgba(100,180,255,0.6)';
    ctx.beginPath();ctx.roundRect(-3*s,-mh-7*s,6*s,2.5*s,1*s);ctx.fill();
    if(oncoming){
      ctx.fillStyle='#FFE082';
      ctx.beginPath();ctx.arc(0,-2*s,2*s,0,Math.PI*2);ctx.fill();
    } else {
      ctx.fillStyle='#f44336';
      ctx.beginPath();ctx.ellipse(0,-2*s,2.5*s,1.2*s,0,0,Math.PI*2);ctx.fill();
    }
  }

  ctx.restore();
}

// ‚ïê‚ïê‚ïê Update ‚ïê‚ïê‚ïê
function update(dt){
  if(gameOver) return;
  const playerSeg=findSegment(position+CAMERA_HEIGHT);
  const speedPercent=speed/maxSpeed;
  const dx=dt*steerSensitivity*speedPercent;

  // Input
  let accelerating=false;
  if(keys['ArrowUp']||keys['w']||keys['W']){speed+=accel*dt;accelerating=true;}
  if(keys['ArrowDown']||keys['s']||keys['S']){speed-=braking*dt;}
  if(keys['ArrowLeft']||keys['a']||keys['A']){playerX-=dx;tilt=Math.max(tilt-dt*5,-1);}
  else if(keys['ArrowRight']||keys['d']||keys['D']){playerX+=dx;tilt=Math.min(tilt+dt*5,1);}
  else{tilt*=Math.pow(0.05,dt);}

  // Touch
  if(touchActive){
    if(touchDY<-15){speed+=accel*dt;accelerating=true;}
    if(touchDY>15){speed-=braking*dt;}
    if(touchDX<-15){playerX-=dx*Math.min(Math.abs(touchDX)/60,1.5);tilt=Math.max(tilt-dt*5,-1);}
    else if(touchDX>15){playerX+=dx*Math.min(Math.abs(touchDX)/60,1.5);tilt=Math.min(tilt+dt*5,1);}
  }

  // Auto start slow
  if(!accelerating && speed===0 && distance===0) { /* wait for input */ }

  // Centrifugal force on curves
  playerX-=dx*speedPercent*playerSeg.curve*centrifugal;

  // Off road slowdown
  if(playerX<-1||playerX>1){
    if(speed>offRoadLimit) speed-=offRoadDecel*dt;
  }

  // Natural decel
  if(!accelerating && speed>0) speed-=decel*dt;

  speed=Math.max(0,Math.min(speed,maxSpeed));
  playerX=Math.max(-2.5,Math.min(2.5,playerX));

  position=increase(position,speed*dt,segments.length*SEGMENT_LENGTH);
  distance+=speed*dt*0.003;

  // Floating texts
  for(let i=floatingTexts.length-1;i>=0;i--){
    const ft=floatingTexts[i];
    ft.y-=80*dt;ft.alpha-=dt*0.6;ft.scale+=dt*0.3;
    if(ft.alpha<=0) floatingTexts.splice(i,1);
  }
  if(flashAlpha>0) flashAlpha=Math.max(0,flashAlpha-dt*2);
  updateEvent(dt);
  updateObstacles(dt);

  // Player's visual world Z (derived from screen position H*0.82)
  const playerZ=position+PLAYER_Z_OFFSET;
  const trackLen=segments.length*SEGMENT_LENGTH;

  // Collision check ‚Äî items (still on segments)
  const playerSegIdx=Math.floor(playerZ/SEGMENT_LENGTH)%segments.length;
  for(let di=-1;di<=1;di++){
    const idx=(playerSegIdx+di+segments.length)%segments.length;
    const seg=segments[idx];
    for(const sp of seg.sprites){
      if(sp.type==='item'&&!sp.collected){
        const dx=Math.abs(sp.offset-playerX);
        if(dx<0.15){
          sp.collected=true;
          triggerItemEvent();
        }
      }
    }
  }

  // Collision check ‚Äî moving obstacles (check near playerZ)
  const hitDepth=SEGMENT_LENGTH;
  for(const ob of movingObstacles){
    let dz=ob.worldZ-playerZ;
    if(dz>trackLen/2) dz-=trackLen;
    if(dz<-trackLen/2) dz+=trackLen;
    if(dz<-hitDepth||dz>hitDepth) continue;
    const dx=Math.abs(ob.offset-playerX);
    const hitW=ob.vehicle==='bus'?0.30:ob.vehicle==='taxi'?0.15:ob.vehicle==='car'?0.14:ob.vehicle==='moto'?0.05:ob.vehicle==='dog'?0.025:0.018;
    if(dx<hitW){
      if(invincible) continue;
      crashDir=ob.offset>playerX?-1:1;
      gameOver=true;crashTimer=0;crashDone=false;speed=0;
      playCrashSound();return;
    }
  }
}

// ‚ïê‚ïê‚ïê Item Event Logic ‚ïê‚ïê‚ïê
function triggerItemEvent(){
  const ev=ITEM_EVENTS[(Math.random()*ITEM_EVENTS.length)|0];
  invincible=false;
  playerScale=1;
  activeEvent={type:ev.type, timer:0, duration:ev.duration, data:{}};
  particles=[];
  playEventSound(ev.type);

  // type-specific init
  if(ev.type==='giant' || ev.type==='star' || ev.type==='angel'){
    invincible=true;
  }
  if(ev.type==='speed'){
    speed=Math.min(speed+maxSpeed*0.5, maxSpeed);
  }
  if(ev.type==='balloon'){
    for(let i=0;i<20;i++) particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*120,
      y:H*0.8, vx:(Math.random()-0.5)*3, vy:-2-Math.random()*4,
      emoji:['üéà','üü°','üîµ','üü¢','üî¥','üü£'][i%6], size:18+Math.random()*16, alpha:1
    });
  }
  if(ev.type==='firework'){
    for(let i=0;i<30;i++){
      const angle=Math.random()*Math.PI*2;
      const spd=2+Math.random()*5;
      particles.push({
        x:W/2, y:H*0.35, vx:Math.cos(angle)*spd, vy:Math.sin(angle)*spd,
        emoji:['‚ú®','üåü','üí•','‚≠ê'][i%4], size:12+Math.random()*12, alpha:1
      });
    }
  }
  if(ev.type==='confetti'){
    for(let i=0;i<40;i++) particles.push({
      x:Math.random()*W, y:-20-Math.random()*100,
      vx:(Math.random()-0.5)*2, vy:2+Math.random()*4,
      color:`hsl(${Math.random()*360},90%,60%)`, size:6+Math.random()*6, alpha:1, rot:Math.random()*6
    });
  }
}

function updateEvent(dt){
  if(!activeEvent) return;
  activeEvent.timer+=dt;

  // Update particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy;
    if(p.vy<10) p.vy+=dt*2; // gravity for some
    if(activeEvent.type==='confetti') p.rot+=dt*3;
    if(activeEvent.type==='hail') p.vy+=dt*15;
    if(activeEvent.type==='sakura'){ p.vx=Math.sin(p.y*0.02+p.x*0.01)*1.5; p.vy+=dt*0.5; }
    if(activeEvent.type==='butterfly'){ p.vx=Math.sin(activeEvent.timer*3+i)*2; p.vy=Math.cos(activeEvent.timer*2+i)*1.5; }
    if(p.y>H+50||p.y<-200||p.x<-50||p.x>W+50) { p.alpha-=dt*2; }
    if(p.alpha<=0) particles.splice(i,1);
  }

  // Giant mode scale
  if(activeEvent.type==='giant'||activeEvent.type==='star'||activeEvent.type==='angel'){
    const ramp=Math.min(activeEvent.timer/0.3,1);
    const fadeOut=activeEvent.timer>activeEvent.duration-0.5? Math.max(0,(activeEvent.duration-activeEvent.timer)/0.5):1;
    playerScale=1+ramp*fadeOut*1;
  }

  // Spawn ongoing particles
  if(activeEvent.type==='fart' && Math.random()<0.4){
    particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*30,
      y:H*0.85, vx:(Math.random()-0.5)*4, vy:-1-Math.random()*3,
      emoji:['üí®','üí©','üò§'][Math.random()*3|0], size:14+Math.random()*14, alpha:1
    });
  }
  if(activeEvent.type==='hail' && Math.random()<0.6){
    particles.push({
      x:Math.random()*W, y:-10, vx:(Math.random()-0.5)*2, vy:8+Math.random()*6,
      emoji:['üßä','‚ùÑÔ∏è','ü´ß'][Math.random()*3|0], size:10+Math.random()*10, alpha:1
    });
  }
  if(activeEvent.type==='heart' && Math.random()<0.35){
    particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*200,
      y:H*0.9, vx:(Math.random()-0.5)*2, vy:-3-Math.random()*3,
      emoji:['üíï','üíñ','üíó','‚ù§Ô∏è','üíò'][Math.random()*5|0], size:14+Math.random()*14, alpha:1
    });
  }
  if(activeEvent.type==='butterfly' && particles.length<15 && Math.random()<0.2){
    particles.push({
      x:Math.random()*W, y:H*0.3+Math.random()*H*0.4,
      vx:0, vy:0,
      emoji:['ü¶ã','ü¶ã','üêù','üêû'][Math.random()*4|0], size:16+Math.random()*12, alpha:1
    });
  }
  if(activeEvent.type==='star' && Math.random()<0.3){
    particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*80,
      y:H*0.6+Math.random()*60, vx:(Math.random()-0.5)*3, vy:-2-Math.random()*2,
      emoji:['‚≠ê','üåü','‚ú®'][Math.random()*3|0], size:10+Math.random()*16, alpha:1
    });
  }
  if(activeEvent.type==='sakura' && Math.random()<0.5){
    particles.push({
      x:Math.random()*W, y:-10, vx:0, vy:1+Math.random()*2,
      emoji:['üå∏','üå∫','üíÆ'][Math.random()*3|0], size:10+Math.random()*14, alpha:1
    });
  }
  if(activeEvent.type==='angel' && Math.random()<0.15){
    particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*60,
      y:H*0.55, vx:(Math.random()-0.5)*2, vy:-2-Math.random()*2,
      emoji:['ü™Ω','‚ú®','üòá','üëº'][Math.random()*4|0], size:12+Math.random()*14, alpha:1
    });
  }
  if(activeEvent.type==='speed' && Math.random()<0.5){
    particles.push({
      x:W/2+playerX*W/3.2+(Math.random()-0.5)*40,
      y:H*0.75+Math.random()*40, vx:0, vy:4+Math.random()*4,
      emoji:['‚ö°','üí®'][Math.random()*2|0], size:12+Math.random()*10, alpha:1
    });
  }

  // End event
  if(activeEvent.timer>=activeEvent.duration){
    invincible=false;
    playerScale=1;
    particles=[];
    activeEvent=null;
  }
}

function renderEventOverlay(){
  if(!activeEvent) return;
  const t=activeEvent.timer;
  const px=W/2+playerX*W/3.2;
  const py=H*0.82;

  // Rainbow road overlay
  if(activeEvent.type==='rainbow'){
    ctx.save();
    ctx.globalAlpha=0.15+Math.sin(t*4)*0.05;
    const rg=ctx.createLinearGradient(0,H*0.5,0,H);
    const hue=(t*120)%360;
    rg.addColorStop(0,`hsla(${hue},100%,50%,0)`);
    rg.addColorStop(0.4,`hsla(${hue},100%,60%,0.3)`);
    rg.addColorStop(0.7,`hsla(${(hue+60)%360},100%,60%,0.3)`);
    rg.addColorStop(1,`hsla(${(hue+120)%360},100%,60%,0.2)`);
    ctx.fillStyle=rg;
    ctx.fillRect(0,H*0.5,W,H*0.5);
    ctx.restore();
  }

  // Disco strobe
  if(activeEvent.type==='disco'){
    ctx.save();
    ctx.globalAlpha=0.08+Math.sin(t*15)*0.06;
    const hue=(t*300)%360;
    ctx.fillStyle=`hsl(${hue},100%,50%)`;
    ctx.fillRect(0,0,W,H);
    ctx.restore();
    // Disco ball
    const bx=W/2, by=H*0.08;
    ctx.save();
    ctx.font=`${Math.max(20,W*0.04)}px serif`;
    ctx.textAlign='center';
    ctx.fillText('ü™©',bx,by+20);
    ctx.restore();
    // Light beams
    ctx.save();ctx.globalAlpha=0.12;
    for(let i=0;i<8;i++){
      const angle=t*2+i*Math.PI/4;
      const ex=bx+Math.cos(angle)*W*0.5;
      const ey=by+Math.sin(angle)*H*0.6+H*0.3;
      const lg=ctx.createLinearGradient(bx,by,ex,ey);
      lg.addColorStop(0,`hsla(${(hue+i*45)%360},100%,70%,0.5)`);
      lg.addColorStop(1,'transparent');
      ctx.strokeStyle=lg;ctx.lineWidth=8;
      ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(ex,ey);ctx.stroke();
    }
    ctx.restore();
  }

  // Cheerleaders on road sides
  if(activeEvent.type==='cheerleader'){
    ctx.save();
    const sz=Math.max(20,W*0.04);
    ctx.font=sz+'px serif';ctx.textAlign='center';
    const bounce=Math.abs(Math.sin(t*6))*15;
    const cheers=['üì£','üéÄ','üëè','üíÉ','üï∫','üôå'];
    for(let i=0;i<6;i++){
      const side=i%2===0?-1:1;
      const yy=H*0.55+i*35-bounce*(i%2===0?1:-1);
      const xx=W/2+side*(W*0.35+Math.sin(t*4+i)*20);
      ctx.fillText(cheers[i],xx,yy);
    }
    // Pom pom wave text
    if(Math.sin(t*3)>0){
      ctx.font=`bold ${Math.max(14,W*0.02)}px 'Segoe UI',sans-serif`;
      ctx.fillStyle='#ff69b4';ctx.globalAlpha=0.8;
      ctx.fillText('ÌôîÏù¥ÌåÖ~!! ‚ú®',W/2,H*0.42+Math.sin(t*5)*8);
    }
    ctx.restore();
  }

  // Draw all particles (emoji-based)
  for(const p of particles){
    ctx.save();
    ctx.globalAlpha=Math.max(0,Math.min(1,p.alpha));
    if(p.emoji){
      ctx.font=Math.round(p.size)+'px serif';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(p.emoji,p.x,p.y);
    } else if(p.color){
      // confetti rectangles
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot||0);
      ctx.fillStyle=p.color;
      ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);
    }
    ctx.restore();
  }

  // Invincible glow around player
  if(invincible){
    ctx.save();
    const glow=ctx.createRadialGradient(px,py,0,px,py,60+Math.sin(t*8)*15);
    const hue=(t*200)%360;
    glow.addColorStop(0,`hsla(${hue},100%,70%,0.25)`);
    glow.addColorStop(1,`hsla(${hue},100%,70%,0)`);
    ctx.fillStyle=glow;
    ctx.beginPath();ctx.arc(px,py,75+Math.sin(t*8)*15,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

// ‚ïê‚ïê‚ïê Render ‚ïê‚ïê‚ïê
function render(){
  ctx.clearRect(0,0,W,H);

  const baseSegment=findSegment(position);
  const basePercent=percentRemaining(position,SEGMENT_LENGTH);
  const playerSegment=findSegment(position+CAMERA_HEIGHT);
  const nextPlayerSeg=findSegment(position+CAMERA_HEIGHT+SEGMENT_LENGTH);
  const hillPercent=percentRemaining(position+CAMERA_HEIGHT,SEGMENT_LENGTH);
  const playerY=interpolate(playerSegment.y,nextPlayerSeg.y,hillPercent);

  let maxy=H;
  let x=0,dx=-(baseSegment.curve*basePercent);

  // Background parallax based on curve
  const bgScroll=playerX*80+dx*500;
  drawBg(bgScroll);

  // ‚îÄ‚îÄ Draw road segments far‚Üínear ‚îÄ‚îÄ
  // First pass: project all visible segments
  for(let n=0;n<DRAW_DISTANCE;n++){
    const idx=(Math.floor(position/SEGMENT_LENGTH)+n)%segments.length;
    const seg=segments[idx];
    const looped=(Math.floor(position/SEGMENT_LENGTH)+n)>=segments.length;

    seg.p.world.y=seg.y;
    seg.p.world.z=(looped?segments.length*SEGMENT_LENGTH:0)+idx*SEGMENT_LENGTH;

    project3d(seg.p,
      playerX*ROAD_W-x,
      CAMERA_HEIGHT+playerY,
      position,
      CAMERA_DEPTH,W,H,ROAD_W);

    x+=dx;
    dx+=seg.curve;
    seg.clip=maxy;

    if(seg.p.screen.y>=maxy||seg.p.camera.z<=0) continue;
    maxy=seg.p.screen.y;
  }

  // Second pass: draw back to front
  maxy=H;
  const spritesToDraw=[];
  for(let n=DRAW_DISTANCE-1;n>0;n--){
    const idx=(Math.floor(position/SEGMENT_LENGTH)+n)%segments.length;
    const seg=segments[idx];
    const prevIdx=(Math.floor(position/SEGMENT_LENGTH)+n-1)%segments.length;
    const prev=segments[prevIdx];

    if(seg.p.camera.z<=0) continue;
    if(seg.p.screen.y>=seg.clip) continue;

    const isEven=((Math.floor(idx/RUMBLE_LENGTH))%2)===0;
    const color=isEven?
      {road:'#6B6B6B',grass:'#10AA10',rumble:'#cc0000',lane:'#CCCCCC'}:
      {road:'#696969',grass:'#009A00',rumble:'#AAAAAA',lane:null};

    const p1=prev.p.screen, p2=seg.p.screen;
    if(p1.y<=0&&p2.y<=0) continue;

    drawSegment(W,LANES,
      p1.x,p1.y,p1.w,
      p2.x,p2.y,p2.w,
      color);

    maxy=Math.min(maxy,p2.y);

    // Collect segment sprites (items, scenery ‚Äî NOT obstacles)
    for(const sp of seg.sprites){
      if(sp.type==='item'&&sp.collected) continue;
      const spriteX=p2.x+p2.w*sp.offset;
      const spriteY=p2.y;
      if(p2.w>0&&spriteY<seg.clip&&spriteY>0){
        spritesToDraw.push({y:spriteY,roadW:p2.w,x:spriteX,emoji:sp.emoji,type:sp.type,vehicle:sp.vehicle,oncoming:sp.oncoming});
      }
    }
  }

  // Collect moving obstacles ‚Äî interpolate between segments for smooth rendering
  const trackLen=segments.length*SEGMENT_LENGTH;
  const baseIdx=Math.floor(position/SEGMENT_LENGTH);
  for(const ob of movingObstacles){
    let dz=ob.worldZ-position;
    if(dz<0) dz+=trackLen;
    if(dz>trackLen/2) continue;
    const segN=Math.floor(dz/SEGMENT_LENGTH);
    const frac=(dz%SEGMENT_LENGTH)/SEGMENT_LENGTH;
    if(segN<1||segN>=DRAW_DISTANCE-1) continue;
    const segIdx=(baseIdx+segN)%segments.length;
    const nextIdx=(baseIdx+segN+1)%segments.length;
    const seg=segments[segIdx];
    const next=segments[nextIdx];
    if(seg.p.camera.z<=0) continue;
    // Use current segment if next is invalid
    const s1=seg.p.screen;
    const s2=next.p.camera.z>0?next.p.screen:s1;
    if(s1.w<=0) continue;
    const spriteX=interpolate(s1.x+s1.w*ob.offset, s2.x+s2.w*ob.offset, frac);
    const spriteY=interpolate(s1.y, s2.y, frac);
    const spriteW=interpolate(s1.w, s2.w, frac);
    if(spriteY>0&&spriteY<H&&spriteW>0){
      spritesToDraw.push({y:spriteY,roadW:spriteW,x:spriteX,emoji:'',type:'obstacle',vehicle:ob.vehicle,oncoming:ob.oncoming,colorIdx:ob.colorIdx});
    }
  }

  // Draw sprites (sorted far to near)
  spritesToDraw.sort((a,b)=>a.y-b.y);
  for(const s of spritesToDraw){
    if(s.type==='item'){
      const bob=Math.sin(Date.now()*0.005)*4;
      const gSize=s.roadW*0.04;
      // Glow
      ctx.save();ctx.globalAlpha=0.3+Math.sin(Date.now()*0.008)*0.12;
      const gg=ctx.createRadialGradient(s.x,s.y-gSize+bob,0,s.x,s.y-gSize+bob,gSize*1.5);
      gg.addColorStop(0,'rgba(255,215,0,0.4)');gg.addColorStop(1,'rgba(255,215,0,0)');
      ctx.fillStyle=gg;ctx.beginPath();ctx.arc(s.x,s.y-gSize+bob,gSize*1.5,0,Math.PI*2);ctx.fill();
      ctx.restore();
      drawSprite(s.emoji,s.x,s.y+bob,s.roadW);
    } else if(s.type==='obstacle'&&s.vehicle){
      drawVehicle(s.vehicle,s.x,s.y,s.roadW,s.oncoming,s.colorIdx);
    } else {
      drawSprite(s.emoji,s.x,s.y,s.roadW);
    }
  }

  // Player
  drawPlayer();

  // Event overlay & particles
  renderEventOverlay();

  // Floating heal texts
  for(const ft of floatingTexts){
    ctx.save();ctx.globalAlpha=ft.alpha;
    ctx.font=`bold ${20*ft.scale}px 'Segoe UI',sans-serif`;
    ctx.textAlign='center';
    ctx.strokeStyle='rgba(0,0,0,0.6)';ctx.lineWidth=3;
    ctx.strokeText(ft.text,ft.x,ft.y);
    ctx.fillStyle='#ffe066';ctx.fillText(ft.text,ft.x,ft.y);
    ctx.restore();
  }

  // ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
  const hudFontSize=Math.max(11,W*0.014);
  ctx.save();
  ctx.font=`bold ${hudFontSize}px 'Segoe UI',sans-serif`;
  ctx.textAlign='center';
  const hudW=hudFontSize*12, hudH=hudFontSize*2.2;
  const hudX=W/2-hudW/2, hudY=8;
  ctx.fillStyle='rgba(0,0,0,0.45)';
  ctx.beginPath();
  ctx.roundRect(hudX,hudY,hudW,hudH,6);ctx.fill();
  ctx.fillStyle='#fff';
  ctx.fillText('üö¥ Ï£ºÌñâ Í±∞Î¶¨: '+Math.floor(distance)+'m',W/2,hudY+hudH*0.6);
  ctx.restore();

  // Speed bar
  const barW=hudW*0.6, barH=3;
  const barX=W/2-barW/2, barY=hudY+hudH+4;
  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(barX,barY,barW,barH);
  const sRatio=speed/maxSpeed;
  const bG=ctx.createLinearGradient(barX,0,barX+barW,0);
  bG.addColorStop(0,'#4caf50');bG.addColorStop(0.7,'#ff9800');bG.addColorStop(1,'#f44336');
  ctx.fillStyle=bG;ctx.fillRect(barX,barY,barW*sRatio,barH);

  // Game Over (shown after fall animation completes)
  if(crashDone){
    ctx.save();
    ctx.textAlign='center';
    // Semi-transparent banner behind text
    ctx.fillStyle='rgba(0,0,0,0.55)';
    const bannerY=H*0.28, bannerH=H*0.22;
    ctx.fillRect(0,bannerY,W,bannerH);

    ctx.font=`bold ${Math.max(32,W*0.06)}px 'Segoe UI',sans-serif`;
    ctx.fillStyle='#ff4444';ctx.strokeStyle='#000';ctx.lineWidth=4;
    ctx.strokeText('GAME OVER',W/2,bannerY+bannerH*0.4);
    ctx.fillText('GAME OVER',W/2,bannerY+bannerH*0.4);
    ctx.font=`bold ${Math.max(18,W*0.028)}px 'Segoe UI',sans-serif`;
    ctx.fillStyle='#fff';
    ctx.fillText('ÏµúÏ¢Ö Í±∞Î¶¨: '+Math.floor(distance)+'m',W/2,bannerY+bannerH*0.75);
    retryBtn.style.display='block';retryBtn.style.top=(bannerY+bannerH+16)+'px';
    ctx.restore();
  }

  // Controls hint
  if(distance<3&&!gameOver){
    ctx.save();ctx.globalAlpha=Math.max(0,1-distance/3);
    const hintW=260,hintH=65,hintX=W/2-hintW/2,hintY=H*0.62;
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.beginPath();ctx.roundRect(hintX,hintY,hintW,hintH,8);ctx.fill();
    ctx.font='14px "Segoe UI",sans-serif';ctx.fillStyle='#fff';ctx.textAlign='center';
    ctx.fillText('‚¨Ü Í∞ÄÏÜç  ‚¨á Î∏åÎ†àÏù¥ÌÅ¨',W/2,hintY+25);
    ctx.fillText('‚¨Ö ‚û° Ï¢åÏö∞ Ïù¥Îèô',W/2,hintY+48);
    ctx.restore();
  }
}

// ‚ïê‚ïê‚ïê Game Loop ‚ïê‚ïê‚ïê
let lastTs=0;
function loop(ts){
  const dt=Math.min((ts-lastTs)/1000,0.05);
  lastTs=ts;
  if(gameOver){
    crashTimer=Math.min(crashTimer+dt,2.0);
    if(crashTimer>=2.0) crashDone=true;
  }
  update(dt);render();
  if(!crashDone) requestAnimationFrame(loop);
}

function reset(){
  position=0;speed=0;playerX=0;tilt=0;distance=0;
  gameOver=false;flashAlpha=0;crashTimer=0;crashDone=false;crashDir=1;floatingTexts=[];
  particles=[];activeEvent=null;invincible=false;playerScale=1;
  for(const seg of segments) for(const sp of seg.sprites) if(sp.type==='item') sp.collected=false;
  for(const ob of movingObstacles) ob.worldZ=ob.initZ;
  retryBtn.style.display='none';
  lastTs=performance.now();
  requestAnimationFrame(loop);
}
retryBtn.addEventListener('click',reset);

// Polyfill roundRect
if(!ctx.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.moveTo(x+r,y);this.lineTo(x+w-r,y);this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r);this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h);this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r);this.quadraticCurveTo(x,y,x+r,y);
  };
}

requestAnimationFrame(loop);
</script>
</body>
</html>
